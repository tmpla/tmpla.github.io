---
layout: post
title: "ç”ŸAjaxã§Fileuploadã‚’ã—ã¦ã¿ã‚‹ã€‚"
categories:
- jQuery
- PHP
tags:
- ajax
- Chrome
- FileUpload
status: publish
type: post
published: true
meta:
  _edit_last: '2'
author:
  login: yokoshima
  email: k.yokoshima@gmail.com
  display_name: yokoshima
  first_name: ''
  last_name: ''
---
<p>ã‚µãƒ³ãƒ—ãƒ«ã§ä½œæˆã—ã¦ã„ã‚‹<a href="http://labelmaker.korokoro.us/">DVDãƒ©ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼</a>ã§ã¯ã€Ajaxã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ã—ãŸã„ãªã¨æ€ã£ã¦ç´ ã®jQueryã§$.ajaxç­‰ã—ã¦ã¿ãŸã®ã§ã™ãŒãƒ€ãƒ¡ã§ã—ãŸã€‚<br />
ã‚ˆãã‚ˆãè€ƒãˆãŸã‚‰fileå±æ€§ã®ãƒ•ã‚©ãƒ¼ãƒ é …ç›®ãŒã‚ã‚‹ã®ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚¤ãƒŠãƒªã§èª­ã‚ãªã„ã¨ãƒ€ãƒ¡ãªã‚“ã ã‚ãªã¨ã‹æ€ã£ã¦ãŸã‚“ã§ã™ãŒã€<br />
jQueryã§ã®FIleuploadãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã‚ã¡ã‚ƒãã¡ã‚ƒã‚ã‚‹ã‚ˆã†ã ã—ã€å®Ÿéš›Ajaxã§ã¯ã©ã†ã‚„ã£ã¦ã‚‹ã®ã‹ãŒçŸ¥ã‚ŠãŸãã¦è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚<br />
ã¡ãªã¿ã«ã€å‰è¿°ã®DVDãƒ©ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼ã§ä½¿ç”¨ã—ã¦ã„ã‚‹jQuery.form.jsã§ã¯ã©ã†ã‚‚iframeã‚’ä½¿ã£ã¦ãªã‚“ã‹ã‚„ã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚</p>
<p>ã¾ãšã¯æ™®é€šã«Formã‚’ã‚µãƒ–ãƒŸãƒƒãƒˆã—ãŸå ´åˆã¯ã©ã‚“ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ã‚‹ã®ã‹ãƒã‚§ãƒƒã‚¯ã€‚<br />
ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹HTMLï¼ˆindex.htmlï¼‰ãŒã“ã‚“ãªæ„Ÿã˜ã€‚</p>
<pre lang="html" escaped="false">
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-31j">
<title>Ajax Test</title>
</head>
<body>
<form action="upload.php" enctype="multipart/form-data" method="post" >
<input type="file" name="file1"/>
<input type="file" name="file2"/>
<input type="text" name="text" value="text" />
<input type="submit" value="GO"/>
</form>
</body>
</html>
</pre>
<p>ãã‚Œã‚’å—ã‘ã‚‹ã‚µãƒ¼ãƒå´ã¯PHPã§ã“ã‚“ãªæ„Ÿã˜ã€‚</p>
<pre lang="php" escaped="false">
<?php

print_r($_FILES);
print_r($_POST);
print_r(file_get_contents("php://input"));
</pre>
<p>ã“ã‚Œã§ã¡ã‚‡ã£ã¨ãƒãƒã£ãŸã®ãŒã€phpã¯file upload(multipart/form-data)ã®å ´åˆã¯ç”Ÿãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¦‹ã‚‹äº‹ãŒå‡ºæ¥ãªã„ã¨ã„ã†è©±ã€‚<br />
ãã®å ´åˆã¯å‹æ‰‹ã«$_FILESå¤‰æ•°ã«æŒ¯ã‚Šåˆ†ã‘ã¦ãã‚Œã¦ã‚‹ã¨ã¯çŸ¥ã‚‰ãªã‹ã£ãŸã€‚<br />
<a href="http://php.net/manual/ja/reserved.variables.httprawpostdata.php">$HTTP_RAW_POST_DATA</a>ã¨ã„ã†ã®ã‚‚ã‚ã‚‹ã‚“ã ã‘ã©ã“ã‚Œã‚‚ä½¿ãˆã¾ã›ã‚“ã€‚RAWã£ã¦ä½ã ã‹ã‚‰ç”Ÿãƒ‡ãƒ¼ã‚¿ãã®ã¾ã¾è¿”ã—ã¦ãã‚Œã‚Œã°è‰¯ã„ã®ã«ã€‚<br />
ãªã®ã§ã€Apacheã®SetEnvIfã‚’ä½¿ã£ã¦multipart/form-dataã˜ã‚ƒãªãã™ã‚Œã°è¦‹ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚ï¼ˆä¸‹è¨˜å‚ç…§ï¼‰<br />
PHPã§ multipart/form-data ã§POSTã•ã‚ŒãŸç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹: Usoinfo blog<br />
<a href="http://blog.usoinfo.info/article/197068137.html">http://blog.usoinfo.info/article/197068137.html</a></p>
<p>ã“ã‚Œã§submitã™ã‚‹ã¨ã€ä¸‹è¨˜ã®ã‚ˆã†ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ã„ã‚‹ã®ãŒè¦‹ãˆã¾ã™ã€‚</p>
<pre>
Array
(
)
Array
(
)
------WebKitFormBoundaryOAqZvGwO4RbeDbIX

Content-Disposition: form-data; name="file1"; filename="circle.gif"

Content-Type: image/gif



GIF89a  Â¢Ã¿Ã¿Ã¿ÃŒÃŒÃŒâ„¢â„¢â„¢fff333!Ã¹Ã¿,  }ÂºÃœÃ¾0ÃŠ9Æ’B:oÃ¹Ã â€¡qM@â€(HlÃ¤ÂÂ¾Ã Ã€Â¹p-KBÂ­BÃ¬;â€“Ã£Â¬Â¹Â¢Â®Ã— )a7Ã†sWÅ¡Ãªâ€â‚¬Â¤ÃµÃ…T8Â·Â¨hÃŒehÃ‰ .Ã â€¡aÃ­ÂÃ£K+ÃdÃµâ€šH>>Ã˜dotOzs[vâ€K$k|Fâ€š/#Ââ€˜â€“â€ºÅ“Â	;

------WebKitFormBoundaryOAqZvGwO4RbeDbIX

Content-Disposition: form-data; name="file2"; filename="circle.gif"

Content-Type: image/gif



GIF89a  Â¢Ã¿Ã¿Ã¿ÃŒÃŒÃŒâ„¢â„¢â„¢fff333!Ã¹Ã¿,  }ÂºÃœÃ¾0ÃŠ9Æ’B:oÃ¹Ã â€¡qM@â€(HlÃ¤ÂÂ¾Ã Ã€Â¹p-KBÂ­BÃ¬;â€“Ã£Â¬Â¹Â¢Â®Ã— )a7Ã†sWÅ¡Ãªâ€â‚¬Â¤ÃµÃ…T8Â·Â¨hÃŒehÃ‰ .Ã â€¡aÃ­ÂÃ£K+ÃdÃµâ€šH>>Ã˜dotOzs[vâ€K$k|Fâ€š/#Ââ€˜â€“â€ºÅ“Â	;

------WebKitFormBoundaryOAqZvGwO4RbeDbIX

Content-Disposition: form-data; name="text"



text

------WebKitFormBoundaryOAqZvGwO4RbeDbIX--

</pre>
<p>è¦‹ã‚‹ã¨ã€ãƒ•ã‚©ãƒ¼ãƒ ã®å†…å®¹ã‚’å¢ƒç•Œï¼ˆboundaryï¼‰ã§åŒºåˆ‡ã‚‰ã‚Œã¦é€ã‚‰ã‚Œã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚Šã¾ã™ãªã€‚<br />
ãã®ã¸ã‚“ã®ãƒ«ãƒ¼ãƒ«ã¯ä¸‹è¨˜ã‚µã‚¤ãƒˆå‚è€ƒã«ã•ã›ã¦é ‚ãã¾ã—ãŸã€‚ï¼ˆã¾ã‚ã€ã‚ã¨RFC1867ã¨ï¼‰<br />
[Studying HTTP] HTTP Message Body<br />
<a href="http://www.studyinghttp.net/body#Multipart">http://www.studyinghttp.net/body#Multipart</a></p>
<p>Ajaxãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹éš›ã«ã‚‚ã€ã“ã®ãƒ«ãƒ¼ãƒ«ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ã‚ã’ã‚Œã°å¯èƒ½ãªã¯ãšã€‚<br />
ãã“ã§ã€UploadFileã®ãƒã‚¤ãƒŠãƒªã‚’å–å¾—ã™ã‚Œã°å¾Œã¯ç°¡å˜ãã†ã§ã™ã€‚</p>
<p>ã§ã™ãŒã€ã“ã®ãƒã‚¤ãƒŠãƒªã‚’å–å¾—ã™ã‚‹ã®ãŒé›£ã—ãã€å¤šåˆ†IEã§ã¯ç„¡ç†ã€‚Firefoxãªã‚‰OK.Chromeã‚‚ãªã‚“ã¨ã‹OKã€‚<br />
input type=fileã®ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€W3C File APIã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã˜ã‚ƒãªã„ã¨ç„¡ç†ãã†ã§ã™ã€‚</p>
<p>File API<br />
<a href="http://www.w3.org/TR/FileAPI/">http://www.w3.org/TR/FileAPI/</a></p>
<p>ã‚ã¨ã¯ã¡ã‚‡ã£ã¨ä¸‹è¨˜ã‚µã‚¤ãƒˆã‚’å‚è€ƒã«Chromeã§ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚<br />
Ajax file upload with pure JavaScript<br />
<a href="http://igstan.ro/posts/2009-01-11-ajax-file-upload-with-pure-javascript.html">http://igstan.ro/posts/2009-01-11-ajax-file-upload-with-pure-javascript.html</a></p>
<p>å…ˆã»ã©ã®index.htmlã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«Ajaxã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ãŸã€‚</p>
<pre lang="html" escaped="false">
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-31j">
<title>Ajax Test</title>
<script type="text/javascript">
window.onload = function(){
	document.forms[0].onsubmit = function(){
		var form = this;
		var e1 = this.file1;
		var e2 = this.file2;
		var file1 = e1.files[0];
		var file2 = e2.files[0];

		var reader1 = new FileReader();
		var reader2 = new FileReader();
		var file1Content, file2Content;
		reader1.onload = function(){
			file1Content = reader1.result;
		}
		reader2.onload = function(){
			file2Content = reader1.result;
		}
		reader1.readAsBinaryString(file1);
		reader2.readAsBinaryString(file2);

		var timer = setInterval(function(){
			var r1 = reader1.readyState;
			var r2 = reader2.readyState;
			
			if (r1 == 2 && r2 == 2){
				clearInterval(timer);
				var boundary = 'boundary';
				var crlf = '\r\n';
				var body = '--' + boundary + crlf;
				if (e1){
					body += 'Content-Disposition: form-data; name=' + e1.name 
						+ '; filename="' + file1.name + '"' + crlf;
					body += 'Content-Type: image/gif' + crlf + crlf;
					body += file1Content + crlf;
					body += '--' + boundary + crlf;
				}
				if (e2){
					body += 'Content-Disposition: form-data; name=' + e2.name 
						+ '; filename="' + file2.name + '"'+ crlf;
					body += 'Content-Type: image/gif' + crlf + crlf;
					body += file2Content + crlf;
					body += '--' + boundary + '--'+ crlf;
				}
		
				var xhr = new XMLHttpRequest();
				xhr.open("POST", form.action, true);
			    xhr.onreadystatechange = function() {
			        if (xhr.readyState === 4) {
			            alert(xhr.responseText);
			        }
			    };
		
			    var contentType = "multipart/form-data; boundary=" + boundary;
			    xhr.setRequestHeader("Content-Type", contentType);
		
			    for (var header in this.headers) {
			        xhr.setRequestHeader(header, headers[header]);
			    }
		
			    xhr.sendAsBinary(body);
			}
		}, 100);
	    return false;
		
	}
	XMLHttpRequest.prototype.sendAsBinary = function(datastr) {
	    function byteValue(x) {
	        return x.charCodeAt(0) & 0xff;
	    }
	    var ords = Array.prototype.map.call(datastr, byteValue);
	    var ui8a = new Uint8Array(ords);
	    this.send(ui8a.buffer);
	}
}
</script>
</head>
<body>
<form action="upload.php" enctype="multipart/form-data" method="post" >
<input type="file" name="file1"/>
<input type="file" name="file2"/>
<input type="text" name="text" value="text" />
<input type="submit" value="GO"/>
</form>
</body>
</html>
</pre>
<p>å‚è€ƒã‚µã‚¤ãƒˆã¯FIreFoxç”¨ãªã®ã§ã¡ã‚‡ã£ã¨é•ã†ãƒˆã‚³ãŒã‚ã‚Šã¾ã™ã€‚Fileã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’èª­ã‚€ã«ã¯ã€FileReaderã¨ã„ã†ã®ã‚’ä½¿ã„ã¾ã™ã€‚<br />
ã“ã‚Œã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ãƒ¢ãƒªä¸Šã«å±•é–‹ã—ã¦ãã‚Œã‚‹ãã†ãªã®ã§ã™ãŒã€åŒæœŸå‡¦ç†ã§ã¯ãªã„ã®ã§ã€èª­ã¿çµ‚ã‚ã‚‹ã¾ã§å¾…ã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br />
ã®ã§ã€FileReader.onloadã§ã€FileReader.resultã®å€¤ã‚’ä¿æŒã—ã¦ãŠã„ã¦ã€FileReader.readyStateãŒ2(DONE)ã«ãªã£ãŸã‚‰å‡¦ç†ç¶šè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚<br />
è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚€ã®ã«ã¯ã‚‚ã†ã¡ã‚‡ã£ã¨ã„ã„æ–¹æ³•ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‘ã©ã¾ã‚ã¨ã‚Šã‚ãˆãšã“ã‚Œã§ã€‚<br />
ã‚ã¨ã¯ã€multipart/form-dataã®boundaryã§ã™ãŒã€æœ€åˆã¨é€”ä¸­ã®å¢ƒç•Œã¯ã€Œ--ã€ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã€æœ€å¾Œã ã‘ã€Œ--ã€ã‚’é ­ã¨ãŠå°»ã«ä»˜ä¸ã—ã¾ã™ã€‚<br />
boundaryæ–‡å­—åˆ—ãŒã€Œaaaã€ãªã‚‰ã°ã€æœ€åˆã¨é€”ä¸­ã¯ã€Œ--aaã€ã«ã€æœ€å¾Œã ã‘ã€Œ--aa--ã€ã«ã—ã¾ã™ã€‚<br />
ã¾ãŸã€XMLHttpRequestã®sendAsBinaryã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã¯å‰è¿°ã®å‚è€ƒã‚µã‚¤ãƒˆã«ã‚ã£ãŸã‚‚ã®ã§ã™ãŒã€ã“ã‚Œã¯FireFoxã«ã—ã‹ãªã„ã‚„ã¤ã ãã†ãªã®ã§ã€Chromeç”¨ã«ã¡ã‚‡ã£ã¨æ‹¡å¼µã—ã¦ã¾ã™ã€‚ï¼ˆå‚è€ƒï¼š<a href="http://choilog.com/katty0324/blog/23">Chromeã§XMLHttpRequest.sendAsBinaryã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ - ã‹ã£ã¦ãƒã®ãƒ–ãƒ­ã‚° | choilog [ãƒãƒ§ã‚¤ãƒ­ã‚°]</a>ï¼‰<br />
ã“ã‚Œã§ã‚ã§ãŸãAjaxã§FileUploadã®ã‚ˆã†ã«ã‚µãƒ¼ãƒã«é€ä¿¡ã§ãã¾ã—ãŸã€‚<br />
ãŸã ä½¿ã„é“ã¯ãªã„ã ã‚ã†ã€‚jQueryã¯å‰å¤§ã ã€‚</p>
<p>ãŸã ã€ã“ã‚ŒãŒé€šç”¨ã™ã‚‹ã®ã¯Firefoxã‚„Chromeã§ã€IEã¯å®Ÿç¾æ–¹æ³•ãŒã‚ã‚‹ã®ã‹ã©ã†ã‹ãŒä¸æ˜ã€‚å€‹äººçš„ã«ã¯IEã¯ã»ã¨ã‚“ã©ä½¿ã‚ãªã„ã®ã§ã„ã„ã®ã ã‘ã©æ°—ã«ãªã‚Šã¾ã™ã­ã€‚</p>
