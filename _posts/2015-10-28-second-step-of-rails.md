---
layout: post
title: "Railsで雛形を作成しよう"
modified: 2015-10-28 21:57:41 +0900
tags: [rails]
categories: [Rails実践講座]
image:
  feature:
  credit:
  creditlink:
comments:
share:
---

[前回]({% post_url 2015-10-27-first-step-of-rails %})でRailsのガワは出来ましたがまだ何も出来ません。
なのでまずはここから主要な機能を作成していきたいと思います。

## モデルを決めよう
殆どのアプリケーションはなんらかの情報を保存し、それを色々な角度から見れるようにするのが目的だと思います。
今回は作るものがブログなので、「記事」と言うものを保存したりなにやらしたりすることになりますね。
なので、一番最初は「記事」を保存出来るように出来たら良いと思います。
Railsでは「記事」と言う日本語のまま扱うとなかなか難しいので英語にして「post」と言う形で扱います。
これはデータベースに保存して扱うことになるのですが、データベースを扱うにはデータベース特有の問い合わせ方法を使用するのが普通です。
殆どのデータベースでは、SQLと言う問い合わせ専用の言語を使って保存されたデータを取り出すのですが、
RailsではこのSQLを使ってデータを取り出すのは稀で、データベースのレコードをRubyのclassのインスタンスとして扱えるようにしています。
このclassが「モデル」と言うもので、その実装方法も色々ありますが、今回は普通に使用するActiveRecordと言うモノを使ってみます。

Railsではほぼ、このモデル一つを扱う為にそれ以外のモノがあると言う感じですね。

ここで一つ覚えておくといいのが、モデルを扱う時に、単数形と複数形を意識する必要がある場合があるということです。
例えば今回は一つの記事は「post」としますが、複数だと「posts」と言う名前で扱う必要がある場合が出て来ます。

## 雛形を作ろう
postモデルを操作する為の一式を生成してくれるコマンドがあります。generate scaffoldと言うコマンドです。
generateと言うのは色々なものをgenerate（生成）してくれるもので良く使いますが、それの更にサブコマンドとしてscaffoldと指定します。
その後にはモデル名とそのモデルの属性とあとはオプションを指定します。
オプションは色々あるようなんですが、とりあえずは今回は触れませんのでデフォルト指定です。

モデル名は通常、ここでは単数形で指定しますが、複数形にしても判断してくれるみたいです。
例えば下記の「post」は「posts」にしても同じ結果になってるみたいです。賢い！

~~~bash
$ rails generate scaffold post title:string body:text published:boolean
~~~

とかってやると、ズラズラ色々生成されるのが出力を見るとわかります。
ちなみに、「あっ、モデル名とか間違えた」と思ってもう一度やり直したい場合はdestroyコマンドで生成したものを削除してくれます。

~~~bash
$ rails destroy scaffold post
~~~

あと、この「generate」とか「destroy」とかは長いので、rubyの伝統？で、コマンドとして判断できる最低文字さえ入れればショートカットとして使えます。例えば「generate」は「g」で「destroy」は「d」とか。

~~~bash
$ rails g scaffold post title:string body:text published:boolean
~~~

これで作成されたはずなので、まずは何も考えず画面が見れるかどうか見てみましょう！
先回ちょろっと触れましたが、機能の確認には同梱のアプリケーション・サーバーを立ち上げる必要があります。
これは「rails server」コマンドを使用します。
また、今回はdockerのコンテナで動かしているrailsアプリにアクセスしたいので、-b 0.0.0.0と言うオプションを追加しています。
これは結構最近変更されたみたいです。
[Default host to localhost when in development mode. · rack/rack@28b0144](https://github.com/rack/rack/commit/28b014484a8ac0bbb388e7eaeeef159598ec64fc)

~~~bash
$ rails server -b0.0.0.0
~~~

これも省略できるので下記の様に書けます。

~~~bash
$ rails s -b0.0.0.0
~~~

そしてdockerホストにアクセスしてみます。dockerのホストのIPアドレスはホストマシンから

~~~bash
$ docker-machine ip default
192.168.99.100
~~~

で確認できますのでそのIPアドレス＆ポートにアクセスしてみます。
私の環境では192.168.99.100なので、http://192.168.99.100:3000/にアクセスしてみます。

![migration-error]({{ site_url }}/images/2015/10/28/migration-error.png)

あれ、なんかエラーが出てますね。
これは、scaffoldでモデル等は作成したけどデータベースがまだ作成されていない時に出るエラーのようです。
なので、データベースを作成するコマンドを実行します。

ちなみに、現時点では使用するデータベースはsqliteと言うデータベースになってます。
お手軽に開発できてかつ、それなりにRDBMSの機能も持っているすぐれもので開発時には持って来いです。

## マイグレーションを実行する
scaffoldで出来たスクリプトのうち、db/migrate以下に出来たスクリプトがありますが、それがマイグレーションスクリプトです。
Railsでは、データベース定義の変更をこのマイグレーションスクリプトを使って管理する事が普通です。
これを実行すればデータベースが作成されますので実行しましょう。

マイグレーションの実行は、「rails」コマンドではなく「rake」コマンドを使います。
ここ最初は間違えるかもしれませんが慣れですね。

~~~bash
$ rake db:migrate
~~~

これで、/postsと言うURLにアクセスしてみると。

![posts]({{site_url}}/images/2015/10/28/posts-list.png)

なんか出来てるっぽいですね！試しに一つpostを作成してみましょう。
この画面から「new post」を選んで、内容を適当に埋めてみます。

![create post]({{site_url}}/images/2015/10/28/create-post.png)

すると、何か出来たっぽい！

![created post]({{site_url}}/images/2015/10/28/created-post.png)

さらにトップに戻ってみればちゃんとリストされている！

![create post list]({{site_url}}/images/2015/10/28/created-post-list.png)

## まとめ
最初はこんな感じで進めていければよいかと思います。

- モデルを決める
- 雛形を作成する
- マイグレーションを実行する

ただ、デザインとかが結構ダサいとはいわずともbootstrapとかを使っていい感じに変えたいですよね。
その辺りを次回は攻めたいと思います。
