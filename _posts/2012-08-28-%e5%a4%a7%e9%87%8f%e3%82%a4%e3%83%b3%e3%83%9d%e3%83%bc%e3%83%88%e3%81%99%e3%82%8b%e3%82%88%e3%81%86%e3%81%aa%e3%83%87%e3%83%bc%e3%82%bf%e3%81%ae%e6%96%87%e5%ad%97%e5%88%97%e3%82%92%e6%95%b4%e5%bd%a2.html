---
layout: post
title: "大量インポートするようなデータの文字列を整形する方法"
categories:
- "開発"
tags:
- linux
- sed
status: publish
type: post
published: true
meta:
  _edit_last: '2'
author:
  login: yokoshima
  email: k.yokoshima@gmail.com
  display_name: yokoshima
  first_name: ''
  last_name: ''
---
<p>一つ１０メガ強のインポート用テキスト(csv）データをWindowsのサクラエディタで一気に置き換えちゃおうと思ったら、<br />
10ファイル一気に開いた時点で完全受付終了した。<br />
ぐるぐるループしてこまめにGUIを更新するようなWindowsの仕組み上それはしょうがないのかもしれん。</p>
<p>なので、Linux上で単純な置き換えをやってみようと思ってsedを使ってみたよ。</p>
<p>日本語マニュアルは下記参照。</p>
<p>sed(1) manual page<br />
<a href="http://www.nxmnpg.com/ja/1/sed">http://www.nxmnpg.com/ja/1/sed</a></p>
<p>使い方は簡単である。こんなファイルを準備した。これをusers.csvとして使う。</p>
<pre>
1,山田太郎,東京都中央区,男性,25
2,鈴木花子,神奈川県横浜市,女性,26
3,佐藤二郎,千葉県松戸市,男性,27
4,高橋良子,埼玉県大宮市,女性,28
5,佐々木三郎,栃木県宇都宮市,男性,29
6,井上直美,東京都杉並区,女性,30
7,吉川四郎,群馬県高崎市,男性,31
8,岡田裕美,静岡県静岡市,女性,32
9,小林五郎,茨城県水戸市,男性,33
10,早川由恵,山梨県甲府市,女性,34
</pre>
<p>このデータはささっと作ったものなので架空のものです。<br />
例えばこれのすべてのフィールドをダブルクオーテーションで囲うとしたら</p>
<pre lang="bash">
# sed -e "s/,/\",\"/g" -e "s/^/\"/g" -e "s/$/\"/g" users.csv 
"1","山田太郎","東京都中央区","男性","25"
"2","鈴木花子","神奈川県横浜市","女性","26"
"3","佐藤二郎","千葉県松戸市","男性","27"
"4","高橋良子","埼玉県大宮市","女性","28"
"5","佐々木三郎","栃木県宇都宮市","男性","29"
"6","井上直美","東京都杉並区","女性","30"
"7","吉川四郎","群馬県高崎市","男性","31"
"8","岡田裕美","静岡県静岡市","女性","32"
"9","小林五郎","茨城県水戸市","男性","33"
"10","早川由恵","山梨県甲府市","女性","34"
</pre>
<p>sedの置き換え部分は-eを複数書けば順次適用される。上記の場合は、カンマの両側にダブルクオーテーションを付けて、<br />
行頭と行末にダブルクオーテーションをつけているだけ。<br />
正規表現で使用する文字(/"(){}等）はバックスラッシュでエスケープする必要があるのでちょっと見づらい。<br />
また、読み込んだファイルにそのまま書き込むことは出来ないのでやるならこれをリダイレクトすれば良い。</p>
<pre lang="bash">
# sed -e "s/,/\",\"/g" -e "s/^/\"/g" -e "s/$/\"/g" users.csv > users.converted.csv
</pre>
<p>あとはデータのマスクなんかに使えるのではなかろうか、というのでちょっと考えてみた。<br />
例えば名前部分を■■■■でマスクするとしたら</p>
<pre lang="bash">
# sed -e "s/^\([0-9]\{1,\}\),\([^,]\{1,\}\),\(.*\)$/,■■■■,/g" users.csv 
1,■■■■,東京都中央区,男性,25
2,■■■■,神奈川県横浜市,女性,26
3,■■■■,千葉県松戸市,男性,27
4,■■■■,埼玉県大宮市,女性,28
5,■■■■,栃木県宇都宮市,男性,29
6,■■■■,東京都杉並区,女性,30
7,■■■■,群馬県高崎市,男性,31
8,■■■■,静岡県静岡市,女性,32
9,■■■■,茨城県水戸市,男性,33
10,■■■■,山梨県甲府市,女性,34
</pre>
<p>これは余計にわかりにくいが、一番目の()内は数字、二番目が名前、３番目はそれ以降の文字なので、<br />
置き換え先はこれを組み合わせている。<br />
住所の部分だったらこう。</p>
<pre lang="bash">
# sed -e "s/^\([0-9]\{1,\}\),\([^,]\{1,\}\),\([^,]\{1,\}\),\(.*\)$/,,■■■■,/g" users.csv 
1,山田太郎,■■■■,男性,25
2,鈴木花子,■■■■,女性,26
3,佐藤二郎,■■■■,男性,27
4,高橋良子,■■■■,女性,28
5,佐々木三郎,■■■■,男性,29
6,井上直美,■■■■,女性,30
7,吉川四郎,■■■■,男性,31
8,岡田裕美,■■■■,女性,32
9,小林五郎,■■■■,男性,33
10,早川由恵,■■■■,女性,34
</pre>
<p>グループ()を一個増やしただけです。<br />
あと重要なのが、正規表現の{+}がどうも使えないようなので、¥{1,¥}にしているのですが、とにかく見づらいね。<br />
これで仕事はしてくれているが、慣れが必要です。</p>
<p>正規表現については、もっといい方法があれば是非教えて下さい。</p>
