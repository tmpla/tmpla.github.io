---
layout: post
title: MySQL5.6で地図データを使ってみる。
categories:
- "開発"
tags:
- Geometry
- MySQL
- OpenGIS
- PostGIS
status: publish
type: post
published: true
meta:
  _edit_last: '2'
author:
  login: yokoshima
  email: k.yokoshima@gmail.com
  display_name: yokoshima
  first_name: ''
  last_name: ''
---
<p>MySQL5.6ではGeometry型の関数が更新されたらしい。<br />
（さっき見たら開発版の5.7のマニュアルも見れるようになっていた）</p>
<p>http://dev.mysql.com/doc/refman/5.6/en/mysql-nutshell.html</p>
<p>見てみると、関数のプレフィックスにST_を付けてOpenGISに準拠したと言うのと、<br />
MBR_なんとかはバウンディングボックスで扱っていたのがシェイプでちゃんと扱うようになった、と言うところが違うところのようだ。<br />
せっかくなのでちょっと触ってみた。<br />
環境はCentOS6.2で、MySQLは</p>
<pre lang="bash">
[root@v157-7-139-240 html]# mysql --version
mysql  Ver 14.14 Distrib 5.6.10, for Linux (x86_64) using  EditLine wrapper
</pre>
<p>MySQLは下記ページを参考にさせて頂いてインストールした。<br />
CentOS6だとrpmがURLでも良いのね…。</p>
<p> CentOS 6.3 に MySQL 5.6 をインストールしてみた - akishin999の日記<br />
<a href="http://d.hatena.ne.jp/akishin999/20130207/1360241401">http://d.hatena.ne.jp/akishin999/20130207/1360241401</a></p>
<p>Geometry型には主に、座標を扱うPOINT, 線を扱うLINESTRING, 面を扱うPOLYGON等がある。<br />
（その他にも色々あるがこれらが基本）<br />
単一POINTなら一レコードでfloat型等で持つことが出来るかもしれないが、POLYGONとなるとたくさんのPOINTの集まりと言う事になるので、これらGEOMETRY型はバイナリデータである。<br />
とりあえずはこんなテーブルを作ってみた。</p>
<pre lang="sql">
CREATE TABLE `points` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `point` point NOT NULL,
  `created_at` int(11) DEFAULT NULL,
  `updated_at` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
);
</pre>
<p>id, created_at, updated_atはフレームワークに合わせた。<br />
pointに東京駅からいくつかのデータを入れてみて、selectしてみると。</p>
<pre lang="sql">
mysql> select * from points;
+----+-----------------------------------------------------------------+---------------------------+------------+------------+
| id | name                                                            | point                     | created_at | updated_at |
+----+-----------------------------------------------------------------+---------------------------+------------+------------+
| 40 | 東京駅の近く                                                    |          较xa@m+7?A@    | 1366016826 | 1366016826 |
| 41 | 東京ステーションホテルの近く                                    |          h@?xa@bO?t4?A@    | 1366016830 | 1366016830 |
| 42 | ジャンクガレッジの近く                                          |          H؂xa@??J?;?A@      | 1366016834 | 1366016834 |
| 43 | とんかつまい泉の近く                                            |          ȟ?xa@??+3?A@      | 1366016855 | 1366016855 |
| 44 | 東京中華食堂の近く                                              |          ?φxa@???r@?A@       | 1366016859 | 1366016859 |
| 45 | エノテカノリーオの近く                                          |          P?|xa@|??'?A@     | 1366016865 | 1366016865 |
| 46 | Yudero 191フロム アル・ケッチァーノの近く                       |         ??xa@???MF?A@       | 1366016872 | 1366016872 |
| 47 | 大地を守るDeliの近く                                            |          ??xa@??T?%?A@       | 1366016879 | 1366016879 |
| 48 | ｅｃｕｔｅ東京ＨａｎａＳＹＵＭＰＯＯの近く                      |          p?xa@>?Cm&?A@     | 1366016889 | 1366016889 |
| 49 | TORAYA TOKYO (トラヤ トウキョウ)の近く                          |          ?,?xa@c??
?A@      | 1366016940 | 1366016940 |
+----+-----------------------------------------------------------------+---------------------------+------------+------------+
10 rows in set (0.00 sec)
</pre>
<p>よく見ると、pointの所がバイナリデータっぽくなっているのがわかると思う。<br />
これをわかりやすい形式にする場合には下記のようにする。</p>
<pre lang="sql">
mysql> select name, astext(point) from areas;
+-----------------------------------------------------------------+---------------------------------------------+
| name                                                            | astext(point)                               |
+-----------------------------------------------------------------+---------------------------------------------+
| 東京駅の近く                                                    | POINT(139.76608224213123 35.68137109687709) |
| 東京ステーションホテルの近く                                    | POINT(139.76589985191822 35.68128830674574) |
| ジャンクガレッジの近く                                          | POINT(139.76597227156162 35.6815072646695)  |
| とんかつまい泉の近く                                            | POINT(139.76643361151218 35.68124909033775) |
| 東京中華食堂の近く                                              | POINT(139.7664564102888 35.681654325624265) |
| エノテカノリーオの近く                                          | POINT(139.76522460579872 35.68090594594557) |
| Yudero 191フロム アル・ケッチァーノの近く                       | POINT(139.76667501032352 35.68183297708615) |
| 大地を守るDeliの近く                                            | POINT(139.76624384522438 35.68084494234359) |
| ｅｃｕｔｅ東京ＨａｎａＳＹＵＭＰＯＯの近く                      | POINT(139.76695463061333 35.68086019324845) |
| TORAYA TOKYO (トラヤ トウキョウ)の近く                          | POINT(139.7657684236765 35.68039068191208)  |
+-----------------------------------------------------------------+---------------------------------------------+
10 rows in set (0.00 sec)
</pre>
<p>astextと言うfunctionで、WellKnownText形式と言う文字列で取得できる。<br />
（ちなみにPostGISはGeoJSONと言う形式でも取得できる。ここをJSONで取れるとかなり楽）<br />
ここで取れた座標は経度、緯度である事にちょっと注意する必要がある。というのは、よくある地図系のアプリケーションは普通、<br />
緯度、経度の順に引数等を設定してあげる必要がある場合が多いから。<br />
これをGoogleMapを使って表示させてみるとこんな感じ。</p>
<p><a href="http://tmpla.info/wp-content/uploads/2013/04/4eb9a401200ddedcf2647b9c93df73e2.png"><img src="http://tmpla.info/wp-content/uploads/2013/04/4eb9a401200ddedcf2647b9c93df73e2-300x163.png" alt="" title="スクリーンショット 2013-04-24 2.07.34" width="300" height="163" class="alignnone size-medium wp-image-1642" /></a></p>
<p>ちなみに、POINTの場合は、x(point), y(point)でも個別に座標を取得できる。</p>
<pre lang="sql">
mysql> select name, x(point),y(point) from points;
+-----------------------------------------------------------------+--------------------+--------------------+
| name                                                            | x(point)           | y(point)           |
+-----------------------------------------------------------------+--------------------+--------------------+
| 東京駅の近く                                                    | 139.76608224213123 |  35.68137109687709 |
| 東京ステーションホテルの近く                                    | 139.76589985191822 |  35.68128830674574 |
| ジャンクガレッジの近く                                          | 139.76597227156162 |   35.6815072646695 |
| とんかつまい泉の近く                                            | 139.76643361151218 |  35.68124909033775 |
| 東京中華食堂の近く                                              |  139.7664564102888 | 35.681654325624265 |
| エノテカノリーオの近く                                          | 139.76522460579872 |  35.68090594594557 |
| Yudero 191フロム アル・ケッチァーノの近く                       | 139.76667501032352 |  35.68183297708615 |
| 大地を守るDeliの近く                                            | 139.76624384522438 |  35.68084494234359 |
| ｅｃｕｔｅ東京ＨａｎａＳＹＵＭＰＯＯの近く                      | 139.76695463061333 |  35.68086019324845 |
| TORAYA TOKYO (トラヤ トウキョウ)の近く                          |  139.7657684236765 |  35.68039068191208 |
+-----------------------------------------------------------------+--------------------+--------------------+
10 rows in set (0.00 sec)
</pre>
<p>ところで、このpointでorder byした場合は何順になるのかどうか、ちょっと数字だけを見てみた。</p>
<pre lang="sql">
mysql> select name, x(point),y(point) from points order by point;
+-----------------------------------------------------------------+--------------------+--------------------+
| name                                                            | x(point)           | y(point)           |
+-----------------------------------------------------------------+--------------------+--------------------+
| Yudero 191フロム アル・ケッチァーノの近く                       | 139.76667501032352 |  35.68183297708615 |
| ジャンクガレッジの近く                                          | 139.76597227156162 |   35.6815072646695 |
| エノテカノリーオの近く                                          | 139.76522460579872 |  35.68090594594557 |
| 東京ステーションホテルの近く                                    | 139.76589985191822 |  35.68128830674574 |
| ｅｃｕｔｅ東京ＨａｎａＳＹＵＭＰＯＯの近く                      | 139.76695463061333 |  35.68086019324845 |
| 東京中華食堂の近く                                              |  139.7664564102888 | 35.681654325624265 |
| TORAYA TOKYO (トラヤ トウキョウ)の近く                          |  139.7657684236765 |  35.68039068191208 |
| とんかつまい泉の近く                                            | 139.76643361151218 |  35.68124909033775 |
| 大地を守るDeliの近く                                            | 139.76624384522438 |  35.68084494234359 |
| 東京駅の近く                                                    | 139.76608224213123 |  35.68137109687709 |
+-----------------------------------------------------------------+--------------------+--------------------+
10 rows in set (0.00 sec)

mysql> select name, x(point),y(point) from points order by point desc;
+-----------------------------------------------------------------+--------------------+--------------------+
| name                                                            | x(point)           | y(point)           |
+-----------------------------------------------------------------+--------------------+--------------------+
| 東京駅の近く                                                    | 139.76608224213123 |  35.68137109687709 |
| 大地を守るDeliの近く                                            | 139.76624384522438 |  35.68084494234359 |
| とんかつまい泉の近く                                            | 139.76643361151218 |  35.68124909033775 |
| TORAYA TOKYO (トラヤ トウキョウ)の近く                          |  139.7657684236765 |  35.68039068191208 |
| 東京中華食堂の近く                                              |  139.7664564102888 | 35.681654325624265 |
| ｅｃｕｔｅ東京ＨａｎａＳＹＵＭＰＯＯの近く                      | 139.76695463061333 |  35.68086019324845 |
| 東京ステーションホテルの近く                                    | 139.76589985191822 |  35.68128830674574 |
| エノテカノリーオの近く                                          | 139.76522460579872 |  35.68090594594557 |
| ジャンクガレッジの近く                                          | 139.76597227156162 |   35.6815072646695 |
| Yudero 191フロム アル・ケッチァーノの近く                       | 139.76667501032352 |  35.68183297708615 |
+-----------------------------------------------------------------+--------------------+--------------------+
10 rows in set (0.00 sec)
</pre>
<p>すると数字とは全然関連がなさそう。何順なんだろうか？</p>
<p>あとは、代表的な関数を試してみる。<br />
例えば、東京駅からそれぞれの距離を出してみる。</p>
<pre lang="sql">
mysql> select name,st_distance((select point from points where id=40), point) from points;
+-----------------------------------------------------------------+------------------------------------------------------------+
| name                                                            | st_distance((select point from points where id=40), point) |
+-----------------------------------------------------------------+------------------------------------------------------------+
| 東京駅の近く                                                    |                                                          0 |
| 東京ステーションホテルの近く                                    |                                     0.00020030076298405367 |
| ジャンクガレッジの近く                                          |                                     0.00017502912291669992 |
| とんかつまい泉の近く                                            |                                      0.0003719489716509381 |
| 東京中華食堂の近く                                              |                                      0.0004692763933648466 |
| エノテカノリーオの近く                                          |                                      0.0009756564292532701 |
| Yudero 191フロム アル・ケッチァーノの近く                       |                                      0.0007514701972218526 |
| 大地を守るDeliの近く                                            |                                      0.0005504127113727168 |
| ｅｃｕｔｅ東京ＨａｎａＳＹＵＭＰＯＯの近く                      |                                      0.0010109817908605955 |
| TORAYA TOKYO (トラヤ トウキョウ)の近く                          |                                      0.0010294151379106847 |
+-----------------------------------------------------------------+------------------------------------------------------------+
10 rows in set (0.00 sec)
</pre>
<p>単位がなんなのか、MySQLのリファレンスからは見つけられなかったのだけども、おそらくキロメートルじゃないかと思う。<br />
ただし、MySQLの場合は、今のところ測地系が考慮されていないので、細かい距離はあまりあてにならないかも。</p>
<p>また、ちょっと効率が悪そうだけれども、密集度？を取得するSQL文をやってみる。<br />
（最初からそうだけど、インデックス等のパフォーマンスは全然考えていない）</p>
<pre lang="sql">
mysql> select a.name, count(b.id) from (select id,name, st_buffer(point, 0.0005) as buf from areas) a, areas b where st_within(b.point,a.buf) and a.id <> b.id group by name;
+----------------------------------------------------------+-------------+
| name                                                     | count(b.id) |
+----------------------------------------------------------+-------------+
| Yudero 191フロム アル・ケッチァーノの近く                |           1 |
| とんかつまい泉の近く                                     |           3 |
| ジャンクガレッジの近く                                   |           2 |
| 大地を守るDeliの近く                                     |           1 |
| 東京ステーションホテルの近く                             |           2 |
| 東京中華食堂の近く                                       |           3 |
| 東京駅の近く                                             |           4 |
+----------------------------------------------------------+-------------+
7 rows in set (0.00 sec)
</pre>
<p>st_bufferで指定座標から指定距離を囲うpolygonが取得できるので、そこに入っている座標をst_withinで取得し、<br />
自分は除去する、のようなSQL。ただ効率悪そうではある。<br />
st_bufferの範囲をgoogle mapで表示させてみると下記の画像のようになる。</p>
<p><a href="http://tmpla.info/wp-content/uploads/2013/04/d317eed8720fe61632ee3c37a1e6560f.png"><img src="http://tmpla.info/wp-content/uploads/2013/04/d317eed8720fe61632ee3c37a1e6560f-300x255.png" alt="" title="スクリーンショット 2013-04-24 2.45.11" width="300" height="255" class="alignnone size-medium wp-image-1645" /></a></p>
<p>なんとなく取得できていそう。<br />
MySQLで標準のGeometryテスト関数はすごく少ないので、これらを組み合わせて色々やる必要がある。<br />
PostGISはすごくバリエーションが豊富なので、地図データを扱うならばPostgreSQL + PostGISを使うのが今のところは良さそう。</p>
